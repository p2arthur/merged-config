name: CI
# author: mrcointreau

on:
  workflow_call:
    inputs:
      project-type:
        description: "Project type: node or python"
        required: true
        type: string
      working-directory:
        description: Working directory
        required: false
        type: string
        default: "."
      # Node-specific
      node-version:
        description: Node.js version
        required: false
        type: string
        default: "22"
      # Python-specific
      python-version:
        description: Python version
        required: false
        type: string
        default: "3.12"
      # Common
      skip-audit:
        description: Skip security audit step
        required: false
        type: boolean
        default: false
      audit-level:
        description: "Minimum vulnerability severity to fail (Node.js only): low, moderate, high, critical"
        required: false
        type: string
        default: "moderate"
      skip-lint:
        description: Skip linting step
        required: false
        type: boolean
        default: false
      skip-test:
        description: Skip test step
        required: false
        type: boolean
        default: false
      skip-build:
        description: Skip build step
        required: false
        type: boolean
        default: false
      pre-test-script:
        description: Script to run before tests
        required: false
        type: string
        default: ""
      lint-command:
        description: Custom lint command (auto-detected if empty)
        required: false
        type: string
        default: ""
      test-command:
        description: Custom test command (auto-detected if empty)
        required: false
        type: string
        default: ""
      build-command:
        description: Custom build command (auto-detected if empty)
        required: false
        type: string
        default: ""
    secrets:
      NPM_TOKEN:
        required: false

permissions:
  contents: read # Required to checkout code

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate project-type
        if: inputs.project-type != 'node' && inputs.project-type != 'python'
        run: |
          echo "::error::project-type must be 'node' or 'python', got '${{ inputs.project-type }}'"
          exit 1

      - name: Validate audit-level
        if: inputs.audit-level != 'low' && inputs.audit-level != 'moderate' && inputs.audit-level != 'high' && inputs.audit-level != 'critical'
        run: |
          echo "::error::audit-level must be 'low', 'moderate', 'high', or 'critical', got '${{ inputs.audit-level }}'"
          exit 1

  ci:
    name: CI
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1 # v4.3.1

      - name: Checkout workflow resources
        uses: actions/checkout@v4.3.1 # v4.3.1
        with:
          repository: p2arthur/merged-config
          ref: main
          path: .github/workflow-resources

      - name: Log Workflow Execution
        shell: bash
        env:
          LOG_DIR: security
          JOB_NAME: ci
          PROJECT_TYPE: ${{ inputs.project-type }}
          WORKING_DIR: ${{ inputs.working-directory }}
          SKIP_AUDIT: ${{ inputs.skip-audit }}
          SKIP_LINT: ${{ inputs.skip-lint }}
          SKIP_TEST: ${{ inputs.skip-test }}
          SKIP_BUILD: ${{ inputs.skip-build }}
          PRE_TEST_SCRIPT: ${{ inputs.pre-test-script }}
          LINT_COMMAND: ${{ inputs.lint-command }}
          TEST_COMMAND: ${{ inputs.test-command }}
          BUILD_COMMAND: ${{ inputs.build-command }}
        run: bash .github/workflow-resources/scripts/workflow-run-log.sh

      - name: Security Audit (npm)
        if: inputs.project-type == 'node' && inputs.skip-audit != true
        shell: bash
        run: |
          npm install --ignore-scripts --no-fund --no-audit
          bash .github/workflow-resources/scripts/npm-audit-log.sh
        env:
          OUT_DIR: security

      - name: Run Node CI
        if: inputs.project-type == 'node'
        uses: p2arthur/merged-config/actions/ci/node@main
        with:
          node-version: ${{ inputs.node-version }}
          working-directory: ${{ inputs.working-directory }}
          npm-token: ${{ secrets.NPM_TOKEN }}
          skip-audit: ${{ inputs.skip-audit }}
          audit-level: ${{ inputs.audit-level }}
          skip-lint: ${{ inputs.skip-lint }}
          skip-test: ${{ inputs.skip-test }}
          skip-build: ${{ inputs.skip-build }}
          pre-test-script: ${{ inputs.pre-test-script }}
          lint-command: ${{ inputs.lint-command }}
          test-command: ${{ inputs.test-command }}
          build-command: ${{ inputs.build-command }}

      - name: Run Python CI
        if: inputs.project-type == 'python'
        uses: p2arthur/merged-config/actions/ci/python@main
        with:
          python-version: ${{ inputs.python-version }}
          working-directory: ${{ inputs.working-directory }}
          skip-audit: ${{ inputs.skip-audit }}
          skip-lint: ${{ inputs.skip-lint }}
          skip-test: ${{ inputs.skip-test }}
          skip-build: ${{ inputs.skip-build }}
          pre-test-script: ${{ inputs.pre-test-script }}
          lint-command: ${{ inputs.lint-command }}
          test-command: ${{ inputs.test-command }}
          build-command: ${{ inputs.build-command }}

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4.4.3 # v4.6.0
        with:
          name: workflow-logs
          path: security/
