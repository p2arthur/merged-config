name: Publish Docs to Algorand Developer Portal
author: p2arthur
description: Publishes documentation to a dedicated docs branch for consumption by the Developer Portal

inputs:
  docs_path:
    description: "Location relative to the repo root of the docs folder"
    required: false
    default: "docs"
  docs_branch:
    description: "Name of the branch to publish the docs to"
    required: false
    default: "docs-dist"
  github_token:
    description: "GitHub token for publishing to docs branch"
    required: true

outputs:
  docs_target:
    description: "The version target that was published (e.g., 'latest' or 'v1.2.3')"
    value: ${{ steps.docs_target.outputs.target }}
  update_latest:
    description: "Whether the latest folder was updated"
    value: ${{ steps.docs_target.outputs.update_latest }}

runs:
  using: composite
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4.4.0 # v4.4.0
      with:
        node-version: 20

    - name: Generate manifest.json
      shell: bash
      run: node "${{ github.action_path }}/generate-manifest.mjs" "${{ inputs.docs_path }}" "${{ github.repository }}" "${{ github.sha }}"

    - name: Determine docs target
      id: docs_target
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          tag="${{ github.event.release.tag_name }}"
          if [[ -z "$tag" ]]; then
            echo "Release event missing tag_name" >&2
            exit 1
          fi
          version="${tag#v}"
          target="v${version}"
          update_latest="true"
        else
          target="latest"
          update_latest="false"
        fi
        echo "target=$target" >> "$GITHUB_OUTPUT"
        echo "update_latest=$update_latest" >> "$GITHUB_OUTPUT"
        echo "Publishing to: $target (update_latest: $update_latest)"

    - name: Checkout docs branch
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        ref: ${{ inputs.docs_branch }}
        path: docs-branch
      continue-on-error: true

    - name: Prepare publish workspace
      shell: bash
      run: |
        docs_path="${{ inputs.docs_path }}"
        target="${{ steps.docs_target.outputs.target }}"

        if [[ -d "docs-branch" ]]; then
          rm -rf docs-branch/.git
          mv docs-branch publish-staging
        else
          mkdir -p publish-staging
        fi

        rm -rf "publish-staging/${target}"
        mkdir -p "publish-staging/${target}"
        cp -R "${docs_path}/." "publish-staging/${target}/"

        if [[ "${{ steps.docs_target.outputs.update_latest }}" == "true" ]]; then
          rm -rf "publish-staging/latest"
          mkdir -p "publish-staging/latest"
          cp -R "${docs_path}/." "publish-staging/latest/"
        fi

    - name: Publish docs branch
      uses: peaceiris/actions-gh-pages@v4.0.0 # v4.0.0
      with:
        github_token: ${{ inputs.github_token }}
        publish_dir: publish-staging
        publish_branch: ${{ inputs.docs_branch }}
        keep_files: false

    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "## Documentation Publish Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Version target**: \`${{ steps.docs_target.outputs.target || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation Branch**: \`${{ inputs.docs_branch }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Build Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Documentation published for DevPortal import (nightly or manual trigger)." >> $GITHUB_STEP_SUMMARY
